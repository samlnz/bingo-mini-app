<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Cards - Beteseb Bingo</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="select-page">
    <div class="container">
        <!-- Header with Wallet Info -->
        <header class="game-header">
            <button class="back-btn" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i>
                <span>Back</span>
            </button>
            
            <div class="wallet-info">
                <div class="wallet-item">
                    <i class="fas fa-wallet"></i>
                    <div>
                        <div class="wallet-label">Main Wallet</div>
                        <div class="wallet-amount" id="mainWallet">0</div>
                    </div>
                </div>
                
                <div class="wallet-item">
                    <i class="fas fa-coins"></i>
                    <div>
                        <div class="wallet-label">Play Wallet</div>
                        <div class="wallet-amount" id="playWallet">0</div>
                    </div>
                </div>
                
                <div class="wallet-item stake-info">
                    <i class="fas fa-bullseye"></i>
                    <div>
                        <div class="wallet-label">Stake</div>
                        <div class="wallet-amount" id="currentStake">10</div>
                    </div>
                </div>
            </div>
            
            <div class="timer-section">
                <i class="fas fa-redo"></i>
                <span>Refresh</span>
                <div class="timer" id="selectionTimer">45 s</div>
            </div>
        </header>

        <!-- Cards Grid (1-96) -->
        <div class="cards-container">
            <div class="cards-grid" id="cardsGrid">
                <!-- Cards 1-96 will be generated here -->
            </div>
        </div>

        <!-- Selection Summary -->
        <div class="selection-summary">
            <div class="summary-info">
                <div class="selected-count">
                    <i class="fas fa-check-circle"></i>
                    <span>Selected: <span id="selectedCardsCount">0</span>/2 cards</span>
                </div>
                <div class="total-cost">
                    <span>Total Cost: <span id="totalCost">0</span></span>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn-secondary" id="clearSelection">
                    <i class="fas fa-trash"></i>
                    Clear
                </button>
                <button class="btn-primary" id="startGame" disabled>
                    <i class="fas fa-play"></i>
                    Start Game
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="index.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="select.html" class="nav-item active">
                <i class="fas fa-dice"></i>
                <span>Game</span>
            </a>
            <a href="history.html" class="nav-item">
                <i class="fas fa-history"></i>
                <span>History</span>
            </a>
            <a href="wallet.html" class="nav-item">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </nav>
    </div>

    <script src="script.js"></script>
    <script>
        // Initialize Telegram
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Load wallet data
        const wallet = JSON.parse(localStorage.getItem('userWallet') || '{"main":0,"play":0,"total":0}');
        const stake = localStorage.getItem('selectedStake') || '10';
        
        // Update UI
        document.getElementById('mainWallet').textContent = wallet.main;
        document.getElementById('playWallet').textContent = wallet.play;
        document.getElementById('currentStake').textContent = stake;
        
        // Generate cards grid 1-96
        function generateCardsGrid() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 96; i++) {
                const card = document.createElement('div');
                card.className = 'number-card';
                card.dataset.number = i;
                card.innerHTML = `
                    <div class="card-number">${i}</div>
                    <div class="card-status">Available</div>
                `;
                
                card.addEventListener('click', () => selectCard(i, card));
                grid.appendChild(card);
            }
        }
        
        // Card selection logic
        let selectedCards = new Set();
        
        function selectCard(number, element) {
            if (selectedCards.has(number)) {
                // Deselect
                selectedCards.delete(number);
                element.classList.remove('selected');
            } else {
                if (selectedCards.size >= 2) {
                    alert('Maximum 2 cards allowed!');
                    return;
                }
                
                // Check if user has enough balance
                const totalCost = (selectedCards.size + 1) * parseInt(stake);
                if (totalCost > wallet.main + wallet.play) {
                    alert('Insufficient balance!');
                    return;
                }
                
                selectedCards.add(number);
                element.classList.add('selected');
            }
            
            updateSelectionSummary();
        }
        
        function updateSelectionSummary() {
            const count = selectedCards.size;
            const totalCost = count * parseInt(stake);
            
            document.getElementById('selectedCardsCount').textContent = count;
            document.getElementById('totalCost').textContent = totalCost;
            
            const startBtn = document.getElementById('startGame');
            startBtn.disabled = count === 0;
            
            if (count > 0) {
                startBtn.innerHTML = `<i class="fas fa-play"></i> Pay ${totalCost} & Start`;
            }
        }
        
        // Timer functionality
        let timeLeft = 45;
        const timerElement = document.getElementById('selectionTimer');
        
        function updateTimer() {
            timerElement.textContent = `${timeLeft} s`;
            timeLeft--;
            
            if (timeLeft < 10) {
                timerElement.classList.add('warning');
            }
            
            if (timeLeft < 0) {
                clearInterval(timerInterval);
                if (selectedCards.size === 0) {
                    alert('Time expired! Auto-selecting cards...');
                    autoSelectCards();
                }
            }
        }
        
        function autoSelectCards() {
            const cards = document.querySelectorAll('.number-card:not(.selected)');
            const availableCards = Array.from(cards);
            
            while (selectedCards.size < 2 && availableCards.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableCards.length);
                const card = availableCards[randomIndex];
                const number = parseInt(card.dataset.number);
                
                if (!selectedCards.has(number)) {
                    selectedCards.add(number);
                    card.classList.add('selected');
                    availableCards.splice(randomIndex, 1);
                }
            }
            
            updateSelectionSummary();
        }
        
        const timerInterval = setInterval(updateTimer, 1000);
        
        // Clear selection
        document.getElementById('clearSelection').addEventListener('click', () => {
            selectedCards.clear();
            document.querySelectorAll('.number-card.selected').forEach(card => {
                card.classList.remove('selected');
            });
            updateSelectionSummary();
        });
        
        // Start game
        document.getElementById('startGame').addEventListener('click', () => {
            if (selectedCards.size === 0) return;
            
            // Deduct from wallet
            const totalCost = selectedCards.size * parseInt(stake);
            let mainBalance = wallet.main;
            let playBalance = wallet.play;
            
            if (playBalance >= totalCost) {
                playBalance -= totalCost;
            } else {
                const remaining = totalCost - playBalance;
                playBalance = 0;
                mainBalance -= remaining;
            }
            
            // Update wallet
            const updatedWallet = {
                main: mainBalance,
                play: playBalance,
                total: mainBalance + playBalance
            };
            
            localStorage.setItem('userWallet', JSON.stringify(updatedWallet));
            localStorage.setItem('selectedCards', JSON.stringify([...selectedCards]));
            localStorage.setItem('gameStake', stake);
            
            // Generate game ID
            const gameId = 'BB' + Math.random().toString(36).substr(2, 6).toUpperCase();
            localStorage.setItem('currentGameId', gameId);
            
            // Redirect to game page
            window.location.href = 'game.html';
        });
        
        // Initialize
        generateCardsGrid();
        updateTimer();
    </script>
</body>
</html>